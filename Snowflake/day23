------------------------------------------ EXTERNAL TABLES ------------------------------------------
/*               
-- Snowflake External tables allow you to query the files stored in the external stage like a regular table,
   That means without moving that data from files to Snowflake tables.
-- External tables access the files stored in external stage areas such as Amazon S3, GCP bucket, or Azure blob storage.
-- External tables store metadata about these data files, such as value(complete record), the filename, and the file row number.
-- External tables are read-only; therefore, no DML operations can be performed on them, but we can use external tables for query     and join operations.
-- Views and materialized views can be created against external tables.
-- Querying data from external tables is likely slower than querying database tables.
-- The advantage of an external table is that you can analyze the data without storing it in Snowflake.                   
-- We will see how to create external tables on stages using internal and external stages.
*/



------------------ From External stages (Amazon S3 cloud) ---------------------------

use database snow_db;

-- Create a schema for External Tables
CREATE or replace schema ext_tble;

-- Create file format object
CREATE OR REPLACE FILE FORMAT csv_ff
    type = csv
    field_delimiter = ','
    skip_header = 1
    empty_field_as_null = TRUE;
    

-- Create storage integration object
-- only account admins can create INTEGRATION objects
create or replace storage integration external_table_integration
    type = external_stage
    storage_provider = s3
    enabled = TRUE
    storage_aws_role_arn = 'arn:aws:iam::510593089103:role/snowflake_learning'
    storage_allowed_locations = ('s3://s-3-buck-et/csv_folder/')
    comment = 'Integration with AWS S3 buckets'; 

-- List all integrations
SHOW STORAGE INTEGRATIONS;

-- granting the usage to the sysadmin
grant usage on integration external_table_integration to role sysadmin;

// Get aws_iam_ueser_arn and update it in  S3 
desc integration external_table_integration; 
    
 -- creating a stage for the S3
create or replace stage stage_external_table
    url = 's3://s-3-buck-et/csv_folder/'
    storage_integration = external_table_integration
    file_format = csv_ff;

-- list the files in the S3 bucket
list @stage_external_table;

-- create an external table in a simple way   -- 1st method 
create or replace external table user_email_ext
with 
location = @stage_external_table  -- /01_sample_user_email.csv
pattern = '.*user.*'
file_format = csv_ff ; 

select * from user_email_ext;

--creating another table to get data in tabular format

create or replace external table user_external (
      id number as (value:c1::number),
      first_name varchar as (value:c2::varchar),
      last_name varchar as (value:c3::varchar),
      email varchar as (value:c4::varchar),
      gender varchar as (value:c5::varchar),
      aboutme varchar as (value:c6::varchar) 
)
with 
location = @stage_external_table
pattern = '.*user.*'
file_format = csv_ff ;

select * from user_external;

----------------------------------------------------
-- run queries for analysis
select * from user_external where gender = 'M';
select * from user_external where email like '%@w3.org';

-- to see the external tables 
desc external table user_external;

show external tables;

-- to see the files it is referring to 
select distinct metadata$filename from user_external;

----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------
--                                  External tables using Internal stages (Local Machine)

-- It is not possible to create an external table on the internal stage 


-- Create file format object
CREATE OR REPLACE FILE FORMAT csv_ff
    type = csv
    field_delimiter = ','
    skip_header = 1
    empty_field_as_null = TRUE;
    
-- create a stage
create or replace stage int_stage
file_format = csv_ff;

-- list a stage
list @int_stage;

-- uploading to int stage

-- use the command prompt and connect to Snowflake using
-- snowsql -a <account_name> -u <user_name> and enter password
-- select db and schema, load the file into the stage
-- using PUT file://path @int_stage;

-- list a stage
list @int_stage;

--creating another table to get data in tabular format in the internal stage

create or replace external table user_external (
      id number as (value:c1::number),
      first_name varchar as (value:c2::varchar),
      last_name varchar as (value:c3::varchar),
      email varchar as (value:c4::varchar),
      gender varchar as (value:c5::varchar),
      aboutme varchar as (value:c6::varchar) 
)
with 
location = @int_stage/01_sample_user_email.csv.gz
file_format = csv_ff ;


-- NOTE: WE CAN NOT CREATE an external table on the internal stage
